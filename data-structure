RAW  →  STAGE (clean&normalize)  →  MART (dashboard-ready)

## Assumtion: The three source datasets are already available in the data warehouse as raw tables in Stage layer (STAGE.WEB_ORDERS, STAGE.CHANNELS, STAGE.LEADS_FUNNEL). 

CREATE OR REPLACE VIEW MART.WEB_DAILY AS
SELECT
    WO.DATE,
    WO.COUNTRY_CODE,
    WO.CAMPAIGN_ID,
    C.CAMPAIGN_NAME,
    C.CHANNEL_3,
    C.CHANNEL_4,
    C.CHANNEL_5,
    SUM(WO.TOTAL_SPEND_EUR) AS SPEND_EUR,
    SUM(WO.NB_OF_SESSIONS) AS SESSIONS,
    SUM(WO.NB_OF_SIGNUPS) AS SIGNUPS,
    SUM(WO.NB_OF_ORDERS) AS ORDERS,
    SUM(WO.NB_OF_POSLITE_ITEMS_ORDERED) AS ITEMS_ORDERED,
    CASE
      WHEN SUM(WO.NB_OF_SESSIONS) = 0 THEN NULL
      ELSE SUM(WO.NB_OF_ORDERS)::FLOAT / SUM(WO.NB_OF_SESSIONS)
    END AS CONVERSION_RATE,

    CASE
      WHEN SUM(WO.NB_OF_SESSIONS) = 0 THEN NULL
      ELSE SUM(WO.NB_OF_SIGNUPS)::FLOAT / SUM(WO.NB_OF_SESSIONS)
    END AS SESSION_TO_SIGNUP_RATE,

    CASE
      WHEN SUM(WO.NB_OF_SIGNUPS) = 0 THEN NULL
      ELSE SUM(WO.NB_OF_ORDERS)::FLOAT / SUM(WO.NB_OF_SIGNUPS)
    END AS SIGNUP_TO_ORDER_RATE,

    CASE
      WHEN SUM(WO.NB_OF_ORDERS) = 0 THEN NULL
      ELSE SUM(WO.TOTAL_SPEND_EUR)::FLOAT / SUM(WO.NB_OF_ORDERS)
    END AS COST_PER_ORDER_EUR,

    CASE
      WHEN SUM(WO.NB_OF_SIGNUPS) = 0 THEN NULL
      ELSE SUM(WO.TOTAL_SPEND_EUR)::FLOAT / SUM(WO.NB_OF_SIGNUPS)
    END AS COST_PER_SIGNUP_EUR

FROM STG.WEB_ORDERS_CLEANED WO
LEFT JOIN STG.CAMPAIGNS_CLEANED C
  ON WO.CAMPAIGN_ID = C.CAMPAIGN_ID
GROUP BY
    WO.DATE,
    WO.COUNTRY_CODE,
    WO.CAMPAIGN_ID,
    C.CAMPAIGN_NAME,
    C.CHANNEL_3,
    C.CHANNEL_4,
    C.CHANNEL_5;


CREATE OR REPLACE VIEW MART.LEADS_FUNNEL_DAILY AS
SELECT
    LF.FUNNEL_DATE AS DATE,
    LF.COUNTRY_CODE,
    LF.CAMPAIGN_ID,
    C.CAMPAIGN_NAME,
    C.CHANNEL_3,
    C.CHANNEL_4,
    C.CHANNEL_5,
    SUM(LF.TOTAL_IMPRESSIONS) AS IMPRESSIONS,
    SUM(LF.TOTAL_CLICKS) AS CLICKS,
    SUM(LF.TOTAL_SPEND) AS SPEND,
    SUM(LF.TOTAL_LEADS) AS LEADS,
    SUM(LF.TOTAL_FAKE_LEADS) AS FAKE_LEADS,
    SUM(LF.TOTAL_SQLS) AS SQLS,
    SUM(LF.TOTAL_MEETING_DONE) AS MEETINGS,
    SUM(LF.TOTAL_SIGNED_LEADS) AS SIGNED_LEADS,
    SUM(LF.TOTAL_POS_LITE_DEALS) AS DEALS,
    CASE 
      WHEN SUM(LF.TOTAL_IMPRESSIONS) = 0 THEN NULL
      ELSE SUM(LF.TOTAL_CLICKS)::FLOAT / SUM(LF.TOTAL_IMPRESSIONS)
    END AS CTR,

    CASE
      WHEN SUM(LF.TOTAL_CLICKS) = 0 THEN NULL
      ELSE SUM(LF.TOTAL_LEADS)::FLOAT / SUM(LF.TOTAL_CLICKS)
    END AS CLICK_TO_LEAD_RATE,

    CASE
      WHEN SUM(LF.TOTAL_LEADS) = 0 THEN NULL
      ELSE SUM(LF.TOTAL_SQLS)::FLOAT / SUM(LF.TOTAL_LEADS)
    END AS LEAD_TO_SQL_RATE,

    CASE
      WHEN SUM(LF.TOTAL_SPEND) = 0 THEN NULL
      ELSE SUM(LF.TOTAL_SPEND)::FLOAT / NULLIF(SUM(LF.TOTAL_LEADS), 0)
    END AS COST_PER_LEAD

FROM STG.LEADS_FUNNEL_CLEANED LF
LEFT JOIN STG.CAMPAIGNS_CLEANED C
  ON LF.CAMPAIGN_ID = C.CAMPAIGN_ID
GROUP BY
    LF.FUNNEL_DATE,
    LF.COUNTRY_CODE,
    LF.CAMPAIGN_ID,
    C.CAMPAIGN_NAME,
    C.CHANNEL_3,
    C.CHANNEL_4,
    C.CHANNEL_5;



## STAGING

CREATE OR REPLACE TABLE STG.WEB_ORDERS_CLEANED AS
SELECT
    TRY_TO_DATE(DATE) AS DATE,
    UPPER(TRIM(COUNTRY_CODE)) AS COUNTRY_CODE,
    REGEXP_REPLACE(TRIM(CAMPAIGN_ID), '\\s+', '') AS CAMPAIGN_ID,
    TRY_TO_DECIMAL(TOTAL_SPEND_EUR, 18, 2) AS TOTAL_SPEND_EUR,
    TRY_TO_NUMBER(NB_OF_SESSIONS) AS NB_OF_SESSIONS,
    TRY_TO_NUMBER(NB_OF_SIGNUPS) AS NB_OF_SIGNUPS,
    TRY_TO_NUMBER(NB_OF_ORDERS) AS NB_OF_ORDERS,
    TRY_TO_NUMBER(NB_OF_POSLITE_ITEMS_ORDERED) AS NB_OF_POSLITE_ITEMS_ORDERED
FROM STG.WEB_ORDERS;


CREATE OR REPLACE TABLE STG.CAMPAIGNS_CLEANED AS
SELECT
    REGEXP_REPLACE(TRIM(CAMPAIGN_ID), '\\s+', '') AS CAMPAIGN_ID,
    LOWER(
      TRIM(
        REGEXP_REPLACE(CAMPAIGN_NAME, '\\s+', ' ')
      )
    ) AS CAMPAIGN_NAME,
    CHANNEL_3,
    CHANNEL_4,
    CHANNEL_5
FROM STG.CHANNELS;

CREATE OR REPLACE TABLE STG.LEADS_FUNNEL_CLEANED AS
SELECT
    TRY_TO_DATE(DATE) AS FUNNEL_DATE,
    UPPER(TRIM(COUNTRY_CODE)) AS COUNTRY_CODE,
    SPLIT_PART(TRIM(CAMPAIGN_ID), '.', 1) AS CAMPAIGN_ID,
    LOWER(
        TRIM(
            REGEXP_REPLACE(CAMPAIGN_NAME, '\\s+', ' ')
        )
    ) AS CAMPAIGN_NAME,
    TRIM(CURRENCY) AS CURRENCY,
    TRIM(PRODUCT) AS PRODUCT,
    TRIM(CHANNEL_3) AS CHANNEL_3,
    TRIM(CHANNEL_4) AS CHANNEL_4,
    TRIM(CHANNEL_5) AS CHANNEL_5,
    TRY_TO_NUMBER(TOTAL_IMPRESSIONS) AS TOTAL_IMPRESSIONS,
    TRY_TO_NUMBER(TOTAL_CLICKS) AS TOTAL_CLICKS,
    TRY_TO_DECIMAL(TOTAL_SPEND, 18, 2) AS TOTAL_SPEND,
    TRY_TO_NUMBER(TOTAL_LEADS) AS TOTAL_LEADS,
    TRY_TO_NUMBER(TOTAL_FAKE_LEADS) AS TOTAL_FAKE_LEADS,
    TRY_TO_NUMBER(TOTAL_SQLS) AS TOTAL_SQLS,
    TRY_TO_NUMBER(TOTAL_MEETING_DONE) AS TOTAL_MEETING_DONE,
    TRY_TO_NUMBER(TOTAL_SIGNED_LEADS) AS TOTAL_SIGNED_LEADS,
    TRY_TO_NUMBER(TOTAL_POS_LITE_DEALS) AS TOTAL_POS_LITE_DEALS
FROM STG.LEADS_FUNNEL;


